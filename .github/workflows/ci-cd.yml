name: PegasusBackend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Step 1: Run tests FIRST
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore PegasusBackend.sln

      - name: Build solution
        run: dotnet build PegasusBackend.sln --configuration Release --no-restore

      - name: Run all tests
        run: dotnet test PegasusBackend.sln --configuration Release --no-build --verbosity normal

  # Step 2: Build Docker image (ONLY IF TESTS PASS)
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test # WAITS for test job to complete successfully
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker image
        run: docker build -t pegasusbackend:latest .

      - name: Test Docker container starts
        run: |
          docker run -d -p 8080:8080 --name test-container -e PORT=8080 pegasusbackend:latest
          sleep 10
          docker ps | grep test-container
          docker stop test-container
          docker rm test-container

  # Step 3: Deploy to Render (ONLY IF EVERYTHING PASSES)
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build-docker # WAITS for Docker build to complete
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Trigger Render deployment
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
